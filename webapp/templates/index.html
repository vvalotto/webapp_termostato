{% extends 'base.html' %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Termostato{% endblock %}

{% block content %}
  <!-- WT-19: Banner de alerta de perdida de conexion -->
  <div id="banner-conexion" class="banner-conexion oculto">
    <div class="container">
      <span class="glyphicon glyphicon-warning-sign banner-icono"></span>
      <span class="banner-mensaje">Sin conexion con el servidor</span>
      <span id="banner-tiempo" class="banner-tiempo"></span>
      <button type="button" class="close banner-cerrar" aria-label="Cerrar">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  </div>

  <!-- WT-19: Notificacion de reconexion -->
  <div id="notificacion-reconexion" class="notificacion-reconexion oculto">
    <span class="glyphicon glyphicon-ok-circle"></span>
    <span>Conexion restablecida</span>
  </div>

  <header class="header-dashboard">
    <div class="container text-center">
      <h1>Dashboard Termostato ISSE</h1>
      <p class="lead">Monitoreo en Tiempo Real</p>
      <!-- WT-10: Estado de conexión visible -->
      <div id="estado-conexion" class="estado-conexion online">
        <span id="icono-estado" class="glyphicon glyphicon-refresh icono-estado"></span>
        <span id="texto-estado">En línea</span>
        <span id="timestamp-estado" class="timestamp-estado">Actualizado hace 0s</span>
      </div>
    </div>
  </header>

  <!-- WT-8: Seccion explicativa colapsable -->
  <div class="container">
    <div class="panel panel-ayuda">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a data-toggle="collapse" href="#seccion-ayuda" class="ayuda-toggle">
            <span class="glyphicon glyphicon-question-sign"></span>
            ¿Como funciona?
            <span class="glyphicon glyphicon-chevron-down toggle-icon"></span>
          </a>
        </h4>
      </div>
      <div id="seccion-ayuda" class="panel-collapse collapse">
        <div class="panel-body">
          <div class="row">
            <!-- Explicacion Climatizador -->
            <div class="col-md-6">
              <h5 class="leyenda-titulo">
                <span class="glyphicon glyphicon-refresh"></span> Estados del Climatizador
              </h5>
              <ul class="leyenda-lista">
                <li>
                  <span class="leyenda-icono estado-apagado"><span class="glyphicon glyphicon-off"></span></span>
                  <strong>APAGADO</strong> - Sistema en espera, temperatura en rango
                </li>
                <li>
                  <span class="leyenda-icono estado-encendido"><span class="glyphicon glyphicon-ok"></span></span>
                  <strong>ENCENDIDO</strong> - Sistema activo
                </li>
                <li>
                  <span class="leyenda-icono estado-enfriando"><span class="glyphicon glyphicon-asterisk"></span></span>
                  <strong>ENFRIANDO</strong> - Aire acondicionado activo
                </li>
                <li>
                  <span class="leyenda-icono estado-calentando"><span class="glyphicon glyphicon-fire"></span></span>
                  <strong>CALENTANDO</strong> - Calefaccion activa
                </li>
              </ul>
            </div>
            <!-- Explicacion Bateria -->
            <div class="col-md-6">
              <h5 class="leyenda-titulo">
                <span class="glyphicon glyphicon-flash"></span> Niveles de Bateria
              </h5>
              <ul class="leyenda-lista">
                <li>
                  <span class="leyenda-icono bateria-normal"><span class="glyphicon glyphicon-ok-circle"></span></span>
                  <strong>NORMAL</strong> - Carga suficiente (&gt;3.5V)
                </li>
                <li>
                  <span class="leyenda-icono bateria-bajo"><span class="glyphicon glyphicon-warning-sign"></span></span>
                  <strong>BAJO</strong> - Considerar recarga (2.5-3.5V)
                </li>
                <li>
                  <span class="leyenda-icono bateria-critico"><span class="glyphicon glyphicon-exclamation-sign"></span></span>
                  <strong>CRITICO</strong> - Riesgo de apagado (&lt;2.5V)
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container dashboard-container">
    <div class="row">

      <!-- Card Ambiente -->
      <div class="col-md-4">
        <div class="dashboard-card card-ambiente">
          <div class="card-icon">
            <span class="glyphicon glyphicon-fire"></span>
          </div>
          <h3 class="card-title" data-toggle="tooltip" data-placement="top"
              title="Temperatura actual del ambiente y objetivo configurado">
            Ambiente <span class="glyphicon glyphicon-info-sign tooltip-icon"></span>
          </h3>
          <div class="card-body">
            <div class="metric-group">
              <label>Temperatura Actual</label>
              <div class="metric-value">
                <span id="valor-temp-ambiente">{{form.temperatura_ambiente}}</span><span class="metric-unit">°C</span>
                <!-- WT-9: Indicador de tendencia -->
                <span id="tendencia-flecha" class="tendencia-flecha"></span>
                <span id="tendencia-icono" class="tendencia-icono"></span>
              </div>
            </div>
            <!-- WT-9: Texto descriptivo de tendencia -->
            <div id="tendencia-texto" class="tendencia-texto"></div>
            <div class="metric-group">
              <label>Temperatura Deseada</label>
              <div class="metric-value"><span id="valor-temp-deseada">{{form.temperatura_deseada}}</span><span class="metric-unit">°C</span></div>
            </div>
            <!-- WT-11: Indicador de diferencia de temperatura -->
            <div class="diferencia-container">
              <div id="diferencia-texto" class="diferencia-texto">Calculando...</div>
              <div class="diferencia-barra-container">
                <div id="diferencia-barra" class="diferencia-barra ok" style="width: 100%"></div>
                <div class="diferencia-objetivo"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Climatizador -->
      <div class="col-md-4">
        <div class="dashboard-card card-climatizador">
          <div class="card-icon">
            <span class="glyphicon glyphicon-refresh"></span>
          </div>
          <h3 class="card-title" data-toggle="tooltip" data-placement="top"
              title="Estado actual del sistema de climatizacion">
            Climatizador <span class="glyphicon glyphicon-info-sign tooltip-icon"></span>
          </h3>
          <div class="card-body">
            <div class="metric-group">
              <label>Estado del Sistema</label>
              <div id="badge-climatizador" class="metric-value estado-badge
                {% if form.estado_climatizador == 'encendido' %}badge-encendido{% else %}badge-apagado{% endif %}">
                {{form.estado_climatizador|upper}}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Batería - WT-18: Alerta visual de bateria baja -->
      <div class="col-md-4">
        <div id="card-bateria" class="dashboard-card card-bateria bateria-nivel-{{form.indicador_bateria|lower}}"
             data-toggle="tooltip" data-placement="top" data-html="true"
             title="{% if form.indicador_bateria|lower == 'normal' %}Bateria con carga suficiente{% elif form.indicador_bateria|lower == 'bajo' %}Bateria baja - Considere recargar pronto{% else %}Bateria critica - Riesgo de apagado inminente{% endif %}">
          <div class="card-icon">
            <span class="glyphicon glyphicon-flash"></span>
          </div>
          <!-- WT-18: Icono de advertencia para BAJO y CRITICO -->
          <span id="icono-alerta-bateria" class="icono-alerta-bateria {% if form.indicador_bateria|lower == 'normal' %}oculto{% endif %}">
            <span class="glyphicon glyphicon-warning-sign"></span>
          </span>
          <h3 class="card-title">
            Bateria <span class="glyphicon glyphicon-info-sign tooltip-icon"></span>
          </h3>
          <div class="card-body">
            <div class="metric-group">
              <label>Carga</label>
              <div class="metric-value"><span id="valor-bateria">{{form.carga_bateria}}</span><span class="metric-unit">V</span></div>
            </div>
            <div class="metric-group">
              <label>Indicador de Carga</label>
              <div id="badge-indicador" class="metric-value nivel-badge
                {% if form.indicador_bateria|lower == 'normal' %}badge-normal{% elif form.indicador_bateria|lower == 'bajo' %}badge-bajo{% else %}badge-critico{% endif %}">
                {{form.indicador_bateria|upper}}
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Gráfica de Evolución de Temperatura -->
    <div class="row">
      <div class="col-md-12">
        <div class="dashboard-card card-grafica">
          <div class="grafica-header">
            <h3 class="card-title">Evolución de Temperatura Ambiente</h3>
            <!-- WT-15: Selector de rango de tiempo -->
            <div class="rango-selector" id="rango-selector">
              <button type="button" class="btn-rango active" data-rango="5min">5 min</button>
              <button type="button" class="btn-rango" data-rango="1h">1 hora</button>
              <button type="button" class="btn-rango" data-rango="6h">6 horas</button>
              <button type="button" class="btn-rango" data-rango="24h">24 horas</button>
            </div>
          </div>
          <div class="card-body">
            <div id="grafica-cargando" class="grafica-cargando oculto">
              <span class="glyphicon glyphicon-refresh spin"></span> Cargando historial...
            </div>
            <canvas id="temperaturaChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráfica de Estados del Climatizador -->
    <div class="row">
      <div class="col-md-12">
        <div class="dashboard-card card-grafica-climatizador">
          <h3 class="card-title">Historial de Estados del Climatizador</h3>
          <div class="card-body">
            <canvas id="climatizadorChart"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div>

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- US-003: Modulos ES6 — entry point unico, el browser resuelve dependencias -->
<script nomodule>alert('Tu navegador no soporta módulos ES6. Por favor actualizá a Chrome 90+, Firefox 88+ o Safari 14+.');</script>
<script type="module" src="{{ url_for('static', filename='js/app.js') }}"></script>
{% endblock %}