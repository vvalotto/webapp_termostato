{% extends 'base.html' %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Termostato{% endblock %}

{% block content %}
  <header class="header-dashboard">
    <div class="container text-center">
      <h1>Dashboard Termostato ISSE</h1>
      <p class="lead">Monitoreo en Tiempo Real</p>
      <!-- WT-10: Estado de conexión visible -->
      <div id="estado-conexion" class="estado-conexion online">
        <span id="icono-estado" class="glyphicon glyphicon-refresh icono-estado"></span>
        <span id="texto-estado">En línea</span>
        <span id="timestamp-estado" class="timestamp-estado">Actualizado hace 0s</span>
      </div>
    </div>
  </header>

  <!-- WT-8: Seccion explicativa colapsable -->
  <div class="container">
    <div class="panel panel-ayuda">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a data-toggle="collapse" href="#seccion-ayuda" class="ayuda-toggle">
            <span class="glyphicon glyphicon-question-sign"></span>
            ¿Como funciona?
            <span class="glyphicon glyphicon-chevron-down toggle-icon"></span>
          </a>
        </h4>
      </div>
      <div id="seccion-ayuda" class="panel-collapse collapse">
        <div class="panel-body">
          <div class="row">
            <!-- Explicacion Climatizador -->
            <div class="col-md-6">
              <h5 class="leyenda-titulo">
                <span class="glyphicon glyphicon-refresh"></span> Estados del Climatizador
              </h5>
              <ul class="leyenda-lista">
                <li>
                  <span class="leyenda-icono estado-apagado"><span class="glyphicon glyphicon-off"></span></span>
                  <strong>APAGADO</strong> - Sistema en espera, temperatura en rango
                </li>
                <li>
                  <span class="leyenda-icono estado-encendido"><span class="glyphicon glyphicon-ok"></span></span>
                  <strong>ENCENDIDO</strong> - Sistema activo
                </li>
                <li>
                  <span class="leyenda-icono estado-enfriando"><span class="glyphicon glyphicon-asterisk"></span></span>
                  <strong>ENFRIANDO</strong> - Aire acondicionado activo
                </li>
                <li>
                  <span class="leyenda-icono estado-calentando"><span class="glyphicon glyphicon-fire"></span></span>
                  <strong>CALENTANDO</strong> - Calefaccion activa
                </li>
              </ul>
            </div>
            <!-- Explicacion Bateria -->
            <div class="col-md-6">
              <h5 class="leyenda-titulo">
                <span class="glyphicon glyphicon-flash"></span> Niveles de Bateria
              </h5>
              <ul class="leyenda-lista">
                <li>
                  <span class="leyenda-icono bateria-normal"><span class="glyphicon glyphicon-ok-circle"></span></span>
                  <strong>NORMAL</strong> - Carga suficiente (&gt;3.5V)
                </li>
                <li>
                  <span class="leyenda-icono bateria-bajo"><span class="glyphicon glyphicon-warning-sign"></span></span>
                  <strong>BAJO</strong> - Considerar recarga (2.5-3.5V)
                </li>
                <li>
                  <span class="leyenda-icono bateria-critico"><span class="glyphicon glyphicon-exclamation-sign"></span></span>
                  <strong>CRITICO</strong> - Riesgo de apagado (&lt;2.5V)
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container dashboard-container">
    <div class="row">

      <!-- Card Ambiente -->
      <div class="col-md-4">
        <div class="dashboard-card card-ambiente">
          <div class="card-icon">
            <span class="glyphicon glyphicon-fire"></span>
          </div>
          <h3 class="card-title" data-toggle="tooltip" data-placement="top"
              title="Temperatura actual del ambiente y objetivo configurado">
            Ambiente <span class="glyphicon glyphicon-info-sign tooltip-icon"></span>
          </h3>
          <div class="card-body">
            <div class="metric-group">
              <label>Temperatura Actual</label>
              <div class="metric-value">
                <span id="valor-temp-ambiente">{{form.temperatura_ambiente}}</span><span class="metric-unit">°C</span>
                <!-- WT-9: Indicador de tendencia -->
                <span id="tendencia-flecha" class="tendencia-flecha"></span>
                <span id="tendencia-icono" class="tendencia-icono"></span>
              </div>
            </div>
            <!-- WT-9: Texto descriptivo de tendencia -->
            <div id="tendencia-texto" class="tendencia-texto"></div>
            <div class="metric-group">
              <label>Temperatura Deseada</label>
              <div class="metric-value"><span id="valor-temp-deseada">{{form.temperatura_deseada}}</span><span class="metric-unit">°C</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Climatizador -->
      <div class="col-md-4">
        <div class="dashboard-card card-climatizador">
          <div class="card-icon">
            <span class="glyphicon glyphicon-refresh"></span>
          </div>
          <h3 class="card-title" data-toggle="tooltip" data-placement="top"
              title="Estado actual del sistema de climatizacion">
            Climatizador <span class="glyphicon glyphicon-info-sign tooltip-icon"></span>
          </h3>
          <div class="card-body">
            <div class="metric-group">
              <label>Estado del Sistema</label>
              <div id="badge-climatizador" class="metric-value estado-badge
                {% if form.estado_climatizador == 'encendido' %}badge-encendido{% else %}badge-apagado{% endif %}">
                {{form.estado_climatizador|upper}}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Batería -->
      <div class="col-md-4">
        <div class="dashboard-card card-bateria">
          <div class="card-icon">
            <span class="glyphicon glyphicon-flash"></span>
          </div>
          <h3 class="card-title" data-toggle="tooltip" data-placement="top"
              title="Nivel de carga de la bateria del termostato">
            Bateria <span class="glyphicon glyphicon-info-sign tooltip-icon"></span>
          </h3>
          <div class="card-body">
            <div class="metric-group">
              <label>Carga</label>
              <div class="metric-value"><span id="valor-bateria">{{form.carga_bateria}}</span><span class="metric-unit">V</span></div>
            </div>
            <div class="metric-group">
              <label>Indicador de Carga</label>
              <div id="badge-indicador" class="metric-value nivel-badge
                {% if form.indicador_bateria == 'normal' %}badge-normal{% else %}badge-bajo{% endif %}">
                {{form.indicador_bateria|upper}}
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Gráfica de Evolución de Temperatura -->
    <div class="row">
      <div class="col-md-12">
        <div class="dashboard-card card-grafica">
          <h3 class="card-title">Evolución de Temperatura Ambiente</h3>
          <div class="card-body">
            <canvas id="temperaturaChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráfica de Estados del Climatizador -->
    <div class="row">
      <div class="col-md-12">
        <div class="dashboard-card card-grafica-climatizador">
          <h3 class="card-title">Historial de Estados del Climatizador</h3>
          <div class="card-body">
            <canvas id="climatizadorChart"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/graficas.js') }}"></script>
<script src="{{ url_for('static', filename='js/actualizador.js') }}"></script>
{% endblock %}